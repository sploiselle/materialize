# Copyright Materialize, Inc. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# apd is for refactoring decimal/numeric in parallel development to the main
# branch

mode cockroach

query T
SELECT pg_typeof('0.2'::apd)
----
apd

query T
SELECT ('0.2'::apd)::text
----
0.2

query T
SELECT ('-0.2'::apd)::text
----
-0.2

query T
SELECT ('2'::apd)::text
----
2

query T
SELECT ('-2'::apd)::text
----
-2

query T
SELECT ('20'::apd)::text
----
20

query T
SELECT ('-20'::apd)::text
----
-20

query T
SELECT ('-1.2e20'::apd)::text
----
-120000000000000000000

query T
SELECT ('1.2e-20'::apd)::text
----
0.000000000000000000012

# Max precision is 39
query T
SELECT ('-123456789012345678.901234567890123456789'::apd)::text
----
-123456789012345678.901234567890123456789

query T
SELECT ('-0.000000000000000000000000000000000000001'::apd)::text
----
-0.000000000000000000000000000000000000001

# Adding zeroes still causes overflow
query error "-123456789012345678.9012345678901234567890" is out of range for type apd: exceeds maximum precision 39
SELECT ('-123456789012345678.9012345678901234567890'::apd)::text

# We will not trim non-zeroes from the end
query error "-123456789012345678.9012345678901234567891" is out of range for type apd: exceeds maximum precision 39
SELECT ('-123456789012345678.9012345678901234567891'::apd)::text

query error "-1.2e40" is out of range for type apd: exceeds maximum precision 39
SELECT ('-1.2e40'::apd)::text

query error "1.2e-40" is out of range for type apd: exceeds maximum precision 39
SELECT ('1.2e-40'::apd)::text

query error invalid input syntax for type apd: invalid decimal syntax: "-123abc456"
SELECT ('-123abc456'::apd)::text;

query T
SELECT ('1e38'::apd + '1e-39'::apd)::text
----
100000000000000000000000000000000000000

# Limited precision means losing commutativity
query T
SELECT ('1e38'::apd + '1e-39'::apd + '-1e38'::apd)::text
----
0

query T
SELECT ('1e38'::apd + '-1e38'::apd + '1e-39'::apd)::text
----
0.000000000000000000000000000000000000001

# Special values

query T
SELECT ('NaN'::apd)::text
----
NaN

query T
SELECT ('NaN'::apd)::text
----
NaN

query error invalid input syntax for type apd: "Infinity"
SELECT ('Infinity'::apd)::text

query error invalid input syntax for type apd: "-Infinity"
SELECT ('-Infinity'::apd)::text

# Addition
query T
SELECT ('1'::apd + '2'::apd)::text
----
3

query T
SELECT ('1.23'::apd + '2.34'::apd)::text
----
3.57

query T
SELECT ('3402823669209384634633746074317682'::apd + '3402823669209384634633746074317682'::apd)::text
----
6805647338418769269267492148635364

query error value out of range: overflow
SELECT ('999999999999999999999999999999999999999'::apd + '1'::apd)::text

query error value out of range: overflow
SELECT ('790123449679012344967901234496790123392'::apd + '790123449679012344967901234496790123392'::apd)::text

query T
SELECT ('NaN'::apd + '2'::apd)::text
----
NaN

# Multiplication
query T
SELECT ('1.1'::apd * '2.2'::apd)::text
----
2.42

query T
SELECT ('1.1'::apd * '-2.2'::apd)::text
----
-2.42

query T
SELECT ('-1.1'::apd * '2.2'::apd)::text
----
-2.42

query T
SELECT ('-1.1'::apd * '-2.2'::apd)::text
----
2.42

query T
SELECT ('-1.1'::apd * '.2'::apd)::text
----
-0.22

query T
SELECT ('.1'::apd * '-2.2'::apd)::text
----
-0.22

query error value out of range: overflow
SELECT ('123456789012345678901234567890123456789'::apd * '10'::apd)::text

query error value out of range: underflow
SELECT ('1E-39'::apd * '.1'::apd)::text

query error value out of range: exceeds maximum precision 39
SELECT ('.123456789012345678901234567890123456789'::apd * '.1'::apd)::text

# known bad behavior in old i128 implementation
query T
SELECT ('1.50000000'::apd * '1.50000000'::apd)::text
----
2.2500000000000000

query T
SELECT ('NaN'::apd - '2'::apd)::text
----
NaN
